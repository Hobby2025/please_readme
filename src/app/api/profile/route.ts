import { NextResponse } from 'next/server';
import { createCanvas, loadImage, CanvasRenderingContext2D } from 'canvas';

// Ìè∞Ìä∏ Îì±Î°ù (Ïã§Ï†ú Íµ¨ÌòÑÏãú ÌïÑÏöî)
// registerFont('./fonts/NanumGothic.ttf', { family: 'NanumGothic' });

/**
 * ÏßÄÏàò Î∂ÑÌè¨ ÎàÑÏ†Å Î∂ÑÌè¨ Ìï®Ïàò Í≥ÑÏÇ∞
 */
function exponentialCdf(x: number): number {
  return 1 - 2 ** -x;
}

/**
 * Î°úÍ∑∏ Ï†ïÍ∑ú Î∂ÑÌè¨ ÎàÑÏ†Å Î∂ÑÌè¨ Ìï®Ïàò Í≥ÑÏÇ∞ (Í∑ºÏÇ¨Í∞í)
 */
function logNormalCdf(x: number): number {
  return x / (1 + x);
}

/**
 * ÏÇ¨Ïö©Ïûê Îû≠ÌÅ¨ Í≥ÑÏÇ∞ Ìï®Ïàò
 */
function calculateRank(stats: any) {
  const { contributions = 0, currentYearCommits = 0, prs = 0, issues = 0, stars = 0 } = stats || {};
  
  // Ï§ëÍ∞ÑÍ∞í Î∞è Í∞ÄÏ§ëÏπò ÏÑ§Ï†ï
  const COMMITS_MEDIAN = 250;
  const COMMITS_WEIGHT = 2;
  const PRS_MEDIAN = 50;
  const PRS_WEIGHT = 3;
  const ISSUES_MEDIAN = 25;
  const ISSUES_WEIGHT = 1;
  const CONTRIBUTIONS_MEDIAN = 200;
  const CONTRIBUTIONS_WEIGHT = 3;
  const STARS_MEDIAN = 50;
  const STARS_WEIGHT = 4;
  
  const TOTAL_WEIGHT = COMMITS_WEIGHT + PRS_WEIGHT + ISSUES_WEIGHT + CONTRIBUTIONS_WEIGHT + STARS_WEIGHT;
  
  // ÌèâÍ∞Ä Ï†êÏàò Í≥ÑÏÇ∞ (0~1 Î≤îÏúÑ)
  const score = 1 - (
    (COMMITS_WEIGHT * exponentialCdf(currentYearCommits / COMMITS_MEDIAN) +
    PRS_WEIGHT * exponentialCdf(prs / PRS_MEDIAN) +
    ISSUES_WEIGHT * exponentialCdf(issues / ISSUES_MEDIAN) +
    CONTRIBUTIONS_WEIGHT * exponentialCdf(contributions / CONTRIBUTIONS_MEDIAN) +
    STARS_WEIGHT * logNormalCdf(stars / STARS_MEDIAN)) / TOTAL_WEIGHT
  );
  
  // ÌçºÏÑºÌÉÄÏùº Í≥ÑÏÇ∞ (0~100%)
  const percentile = score * 100;
  
  // Îì±Í∏â ÏûÑÍ≥ÑÍ∞í Î∞è Îì±Í∏â Ï†ïÏùò
  const THRESHOLDS = [1, 12.5, 25, 37.5, 50, 62.5, 75, 87.5, 100];
  const rankIndex = THRESHOLDS.findIndex(t => percentile <= t);
  
  // Î¨¥ÏßÄÍ∞ú ÏÉâÏÉÅÏóê ÎßûÎäî Îì±Í∏âÎ≥Ñ ÏÑ§Ï†ï
  const RANKS = [
    { 
      name: 'S', 
      color: '#9400D3', 
      emoji: 'üîÆ',
      mainColor: '#9400D3',
      accentColor: '#8A2BE2',
      headerBg: '#8A2BE280',
      highlightColor: '#9400D3'
    },
    { 
      name: 'A+', 
      color: '#4B0082', 
      emoji: 'üëë',
      mainColor: '#4B0082',
      accentColor: '#483D8B',
      headerBg: '#483D8B80',
      highlightColor: '#4B0082'
    },
    { 
      name: 'A', 
      color: '#0000FF', 
      emoji: 'üåä',
      mainColor: '#0000FF',
      accentColor: '#1E90FF',
      headerBg: '#1E90FF80',
      highlightColor: '#0000FF'
    },
    { 
      name: 'A-', 
      color: '#00FF00', 
      emoji: 'üåø',
      mainColor: '#00FF00',
      accentColor: '#32CD32',
      headerBg: '#32CD3280',
      highlightColor: '#00FF00'
    },
    { 
      name: 'B+', 
      color: '#FFFF00', 
      emoji: '‚≠ê',
      mainColor: '#FFFF00',
      accentColor: '#FFD700',
      headerBg: '#FFD70080',
      highlightColor: '#FFFF00'
    },
    { 
      name: 'B', 
      color: '#FFA500', 
      emoji: 'üî•',
      mainColor: '#FFA500',
      accentColor: '#FF8C00',
      headerBg: '#FF8C0080',
      highlightColor: '#FFA500'
    },
    { 
      name: 'B-', 
      color: '#FF4500', 
      emoji: 'üöÄ',
      mainColor: '#FF4500',
      accentColor: '#FF6347',
      headerBg: '#FF634780',
      highlightColor: '#FF4500'
    },
    { 
      name: 'C+', 
      color: '#FF0000', 
      emoji: 'üí´',
      mainColor: '#FF0000',
      accentColor: '#DC143C',
      headerBg: '#DC143C80',
      highlightColor: '#FF0000'
    },
    { 
      name: 'C', 
      color: '#8B0000', 
      emoji: '‚ú®',
      mainColor: '#8B0000',
      accentColor: '#B22222',
      headerBg: '#B2222280',
      highlightColor: '#8B0000'
    }
  ];
  
  return { ...RANKS[rankIndex], percentile };
}

export async function GET(request: Request) {
  try {
    const { searchParams } = new URL(request.url);
    const name = searchParams.get('name') || 'GitHub ÏÇ¨Ïö©Ïûê';
    const bio = searchParams.get('bio') || 'ÏïàÎÖïÌïòÏÑ∏Ïöî, Ï†ú GitHub ÌîÑÎ°úÌïÑÏóê Ïò§Ïã† Í≤ÉÏùÑ ÌôòÏòÅÌï©ÎãàÎã§!';
    const theme = searchParams.get('theme') || 'default';
    const username = searchParams.get('username') || '';
    const skills = searchParams.get('skills') ? searchParams.get('skills')!.split(',') : [];
    
    // GitHub ÌÜµÍ≥Ñ Í∏∞Î≥∏Í∞í
    const githubStats = {
      stars: parseInt(searchParams.get('stars') || '0'),
      commits: parseInt(searchParams.get('commits') || '0'),
      prs: parseInt(searchParams.get('prs') || '0'),
      issues: parseInt(searchParams.get('issues') || '0'),
      contributions: parseInt(searchParams.get('contributions') || '0'),
      currentYearCommits: parseInt(searchParams.get('currentYearCommits') || '0'),
      languages: {}
    };
    
    // Îû≠ÌÅ¨ Í≥ÑÏÇ∞
    const rank = calculateRank(githubStats);
    
    // Ï∫îÎ≤ÑÏä§ ÌÅ¨Í∏∞ ÏÑ§Ï†ï
    const width = 800;
    const height = 600;
    
    // Ï∫îÎ≤ÑÏä§ ÏÉùÏÑ±
    const canvas = createCanvas(width, height);
    const ctx = canvas.getContext('2d');
    
    // ÌÖåÎßàÏóê Îî∞Î•∏ Î∞∞Í≤ΩÏÉâ ÏÑ§Ï†ï
    const isDark = theme === 'dark';
    const bgColor = isDark ? '#1f2937' : '#ffffff';
    const textColor = isDark ? '#ffffff' : '#1f2937';
    
    // Î∞∞Í≤Ω Í∑∏Î¶¨Í∏∞
    ctx.fillStyle = bgColor;
    ctx.fillRect(0, 0, width, height);
    
    // Ìó§Îçî Í∑∏Î¶¨Í∏∞
    ctx.fillStyle = rank.headerBg;
    ctx.fillRect(0, 0, width, 80);
    
    // ÏïÑÎ∞îÌÉÄ Î°úÎìú Î∞è Í∑∏Î¶¨Í∏∞
    try {
      const avatarSize = 60;
      const avatarX = 30;
      const avatarY = 10;
      
      // ÏïÑÎ∞îÌÉÄ ÏõêÌòï Î∞∞Í≤Ω
      ctx.fillStyle = '#ffffff';
      ctx.beginPath();
      ctx.arc(avatarX + avatarSize/2, avatarY + avatarSize/2, avatarSize/2, 0, Math.PI * 2);
      ctx.fill();
      
      // ÏïÑÎ∞îÌÉÄ ÌÖåÎëêÎ¶¨
      ctx.strokeStyle = rank.accentColor;
      ctx.lineWidth = 3;
      ctx.beginPath();
      ctx.arc(avatarX + avatarSize/2, avatarY + avatarSize/2, avatarSize/2, 0, Math.PI * 2);
      ctx.stroke();
      
      if (username) {
        const avatar = await loadImage(`https://github.com/${username}.png`);
        
        // ÏïÑÎ∞îÌÉÄ ÌÅ¥Î¶¨Ìïë
        ctx.save();
        ctx.beginPath();
        ctx.arc(avatarX + avatarSize/2, avatarY + avatarSize/2, avatarSize/2 - 2, 0, Math.PI * 2);
        ctx.clip();
        ctx.drawImage(avatar, avatarX, avatarY, avatarSize, avatarSize);
        ctx.restore();
      }
    } catch (error) {
      console.error('ÏïÑÎ∞îÌÉÄ Î°úÎìú Ïã§Ìå®:', error);
    }
    
    // Ïù¥Î¶Ñ Í∑∏Î¶¨Í∏∞
    ctx.font = 'bold 24px Arial';
    ctx.fillStyle = '#ffffff';
    ctx.textAlign = 'left';
    ctx.fillText(name, 110, 35);
    
    // ÏÇ¨Ïö©ÏûêÎ™Ö Í∑∏Î¶¨Í∏∞
    if (username) {
      ctx.font = '16px Arial';
      ctx.fillStyle = rank.accentColor;
      ctx.fillText(`@${username}`, 110, 60);
    }
    
    // ÌòÑÏû¨ ÎÇ†Ïßú Í∑∏Î¶¨Í∏∞
    const now = new Date();
    const dateStr = `${now.getFullYear()}. ${now.getMonth() + 1}. ${now.getDate()}`;
    ctx.font = '12px Arial';
    ctx.fillStyle = '#ffffff';
    ctx.textAlign = 'left';
    ctx.fillText(dateStr, 20, height - 20);
    
    // Ìë∏ÌÑ∞ Í∑∏Î¶¨Í∏∞
    ctx.fillStyle = rank.headerBg;
    ctx.fillRect(0, height - 40, width, 40);
    
    ctx.font = '12px Arial';
    ctx.fillStyle = '#ffffff';
    ctx.textAlign = 'right';
    ctx.fillText('created by Please Readme', width - 20, height - 20);
    
    // ÏûêÍ∏∞ÏÜåÍ∞ú Í∑∏Î¶¨Í∏∞
    if (bio) {
      // ÏûêÍ∏∞ÏÜåÍ∞ú Î∞∞Í≤Ω
      const bioY = 100;
      const bioHeight = 100;
      
      // Î∞∞Í≤ΩÏÉâ ÏÑ§Ï†ï
      ctx.fillStyle = isDark ? '#374151' : '#f3f4f6';
      roundRect(ctx, 20, bioY, width - 40, bioHeight, 8, true);
      
      // ÌÖåÎëêÎ¶¨ Í∑∏Î¶¨Í∏∞
      ctx.strokeStyle = rank.mainColor;
      ctx.lineWidth = 2;
      roundRect(ctx, 20, bioY, width - 40, bioHeight, 8, false, true);
      
      // Îî∞Ïò¥Ìëú ÏïÑÏù¥ÏΩò
      ctx.fillStyle = rank.accentColor;
      ctx.fillText('‚ùù', 35, bioY + 25);
      ctx.textAlign = 'right';
      ctx.fillText('‚ùû', width - 35, bioY + bioHeight - 20);
      ctx.textAlign = 'left';
      
      // ÏûêÍ∏∞ÏÜåÍ∞ú ÌÖçÏä§Ìä∏
      ctx.font = '16px Arial';
      ctx.fillStyle = textColor;
      wrapText(ctx, bio, width / 2, bioY + 50, width - 100, 20);
    }
    
    // Í∏∞Ïà† Ïä§ÌÉù Í∑∏Î¶¨Í∏∞
    if (skills.length > 0) {
      const skillsY = 220;
      const skillsHeight = 100;
      
      // Î∞∞Í≤ΩÏÉâ ÏÑ§Ï†ï
      ctx.fillStyle = isDark ? '#374151' : '#f3f4f6';
      roundRect(ctx, 20, skillsY, width - 40, skillsHeight, 8, true);
      
      // ÌÖåÎëêÎ¶¨ Í∑∏Î¶¨Í∏∞
      ctx.strokeStyle = rank.mainColor;
      ctx.lineWidth = 2;
      roundRect(ctx, 20, skillsY, width - 40, skillsHeight, 8, false, true);
      
      // Ïä§ÌÉù Ï†úÎ™©
      ctx.font = 'bold 18px Arial';
      ctx.fillStyle = rank.accentColor;
      ctx.fillText('Stacks', 40, skillsY + 30);
      
      // Ïä§ÌÇ¨ Î∞∞ÏßÄ Í∑∏Î¶¨Í∏∞
      ctx.font = '14px Arial';
      let skillX = 40;
      let skillY = skillsY + 60;
      
      for (const skill of skills) {
        const badgeWidth = ctx.measureText(skill).width + 20;
        
        if (skillX + badgeWidth > width - 40) {
          skillX = 40;
          skillY += 30;
        }
        
        // Î∞∞ÏßÄ Î∞∞Í≤Ω
        ctx.fillStyle = rank.accentColor;
        roundRect(ctx, skillX, skillY - 15, badgeWidth, 25, 12, true);
        
        // Î∞∞ÏßÄ ÌÖçÏä§Ìä∏
        ctx.fillStyle = '#ffffff';
        ctx.textAlign = 'center';
        ctx.fillText(skill, skillX + badgeWidth / 2, skillY);
        ctx.textAlign = 'left';
        
        skillX += badgeWidth + 10;
      }
    }
    
    // GitHub ÌÜµÍ≥Ñ Í∑∏Î¶¨Í∏∞
    const statsY = 340;
    
    // ÌÜµÍ≥Ñ Ïπ¥Îìú Í∑∏Î¶¨Í∏∞
    drawStatCard(ctx, 'Total Commits | ' + new Date().getFullYear(), githubStats.currentYearCommits.toString(), 20, statsY, (width - 60) / 2, 60, isDark, rank.mainColor, rank.highlightColor, textColor);
    drawStatCard(ctx, 'Total PRs', githubStats.prs.toString(), width / 2 + 10, statsY, (width - 60) / 2, 60, isDark, rank.mainColor, rank.highlightColor, textColor);
    drawStatCard(ctx, 'Total Issues', githubStats.issues.toString(), 20, statsY + 70, (width - 60) / 2, 60, isDark, rank.mainColor, rank.highlightColor, textColor);
    drawStatCard(ctx, 'Total Stars', githubStats.stars.toString(), width / 2 + 10, statsY + 70, (width - 60) / 2, 60, isDark, rank.mainColor, rank.highlightColor, textColor);
    
    // Îû≠ÌÅ¨ Ïπ¥Îìú Í∑∏Î¶¨Í∏∞
    const rankY = 430;
    ctx.fillStyle = isDark ? '#374151' : '#f3f4f6';
    roundRect(ctx, 20, rankY, width - 40, 60, 8, true);
    
    // Îû≠ÌÅ¨ ÌÖåÎëêÎ¶¨
    ctx.strokeStyle = rank.mainColor;
    ctx.lineWidth = 2;
    ctx.strokeStyle = rank.mainColor;
    ctx.beginPath();
    ctx.moveTo(24, rankY);
    ctx.lineTo(24, rankY + 60);
    ctx.lineWidth = 4;
    ctx.stroke();
    
    // Îû≠ÌÅ¨ ÌëúÏãú
    ctx.font = 'bold 16px Arial';
    ctx.fillStyle = rank.highlightColor;
    ctx.textAlign = 'left';
    ctx.fillText(`${rank.emoji} Rank : ${rank.name}`, 40, rankY + 35);
    
    // Í∏∞Ïó¨ÎèÑ ÌëúÏãú
    ctx.font = '14px Arial';
    ctx.fillStyle = textColor;
    ctx.textAlign = 'right';
    ctx.fillText(`Contributions | ${new Date().getFullYear()} : `, width - 100, rankY + 35);
    
    ctx.font = 'bold 14px Arial';
    ctx.fillStyle = rank.highlightColor;
    ctx.fillText(githubStats.contributions.toString(), width - 60, rankY + 35);
    
    // Ï∫îÎ≤ÑÏä§Î•º PNGÎ°ú Î≥ÄÌôò
    const buffer = canvas.toBuffer('image/png');
    
    return new NextResponse(buffer, {
      headers: {
        'Content-Type': 'image/png',
        'Cache-Control': 'public, max-age=60, s-maxage=60',
        'Access-Control-Allow-Origin': '*',
      },
    });
  } catch (error) {
    console.error('Ïù¥ÎØ∏ÏßÄ ÏÉùÏÑ± Ïò§Î•ò:', error);
    return NextResponse.json({ error: 'Ïù¥ÎØ∏ÏßÄ ÏÉùÏÑ±Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.' }, { status: 500 });
  }
}

// ÌÖçÏä§Ìä∏ ÎûòÌïë Ìï®Ïàò
function wrapText(ctx: CanvasRenderingContext2D, text: string, x: number, y: number, maxWidth: number, lineHeight: number) {
  const words = text.split(' ');
  let line = '';
  let testLine = '';
  let lineCount = 0;

  ctx.textAlign = 'center';

  for (let n = 0; n < words.length; n++) {
    testLine = line + words[n] + ' ';
    const metrics = ctx.measureText(testLine);
    const testWidth = metrics.width;
    
    if (testWidth > maxWidth && n > 0) {
      ctx.fillText(line, x, y + (lineCount * lineHeight));
      line = words[n] + ' ';
      lineCount++;
    } else {
      line = testLine;
    }
  }
  
  ctx.fillText(line, x, y + (lineCount * lineHeight));
}

// Îë•Í∑º ÏÇ¨Í∞ÅÌòï Í∑∏Î¶¨Í∏∞ Ìï®Ïàò
function roundRect(
  ctx: CanvasRenderingContext2D,
  x: number,
  y: number,
  width: number,
  height: number,
  radius: number = 5,
  fill: boolean = false,
  stroke: boolean = false
) {
  ctx.beginPath();
  ctx.moveTo(x + radius, y);
  ctx.lineTo(x + width - radius, y);
  ctx.quadraticCurveTo(x + width, y, x + width, y + radius);
  ctx.lineTo(x + width, y + height - radius);
  ctx.quadraticCurveTo(x + width, y + height, x + width - radius, y + height);
  ctx.lineTo(x + radius, y + height);
  ctx.quadraticCurveTo(x, y + height, x, y + height - radius);
  ctx.lineTo(x, y + radius);
  ctx.quadraticCurveTo(x, y, x + radius, y);
  ctx.closePath();
  
  if (fill) {
    ctx.fill();
  }
  
  if (stroke) {
    ctx.stroke();
  }
}

// ÌÜµÍ≥Ñ Ïπ¥Îìú Í∑∏Î¶¨Í∏∞ Ìï®Ïàò
function drawStatCard(
  ctx: CanvasRenderingContext2D,
  label: string,
  value: string,
  x: number,
  y: number,
  width: number,
  height: number,
  isDark: boolean,
  borderColor: string,
  valueColor: string,
  textColor: string
) {
  // Î∞∞Í≤Ω
  ctx.fillStyle = isDark ? '#374151' : '#f3f4f6';
  roundRect(ctx, x, y, width, height, 8, true);
  
  // ÌÖåÎëêÎ¶¨
  ctx.strokeStyle = borderColor;
  ctx.lineWidth = 2;
  ctx.beginPath();
  ctx.moveTo(x + 4, y);
  ctx.lineTo(x + 4, y + height);
  ctx.lineWidth = 4;
  ctx.stroke();
  
  // Î†àÏù¥Î∏î
  ctx.font = '14px Arial';
  ctx.fillStyle = textColor;
  ctx.textAlign = 'left';
  ctx.fillText(label, x + 20, y + 30);
  
  // Í∞í
  ctx.font = 'bold 18px Arial';
  ctx.fillStyle = valueColor;
  ctx.textAlign = 'right';
  ctx.fillText(value, x + width - 20, y + 30);
} 